<!doctype html>

<html lang="pl">
<head>
<title>Programowanie Gier 2D Mateusz J.</title>
  <meta charset="utf-8">
  <meta name="description" content="Zrealizowanie gry w ramach zadania Animacja 1.">
  <meta name="author" content="Mateusz Janiak">
</head>

<body>
    <a href="index.html">Wroc</a><br/>

    <p>Use arrows to move and space to shot. Be careful! When more than 4 bubbles will spawn you will lose your live.</p>
    <p id="gameover">Good luck!</p>
    <canvas id="bubbleGame" width="800" height="600" style="border:2px solid #d3d3d3;"> </canvas><br />
    <p>Score: </p></p><p id="score"></p><br />
    <p>Lives: </p></p><p id="lives"></p><br />
    <script>
        // helper functions

        // generate random integer number
        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
        }

        // generate rgb string from integer values
        function rgb(r, g, b){
            return "rgb("+r+","+g+","+b+")";
        }

        // arrow listener
        function keyCallback(event){
            switch (event.key) {
                case "ArrowLeft":
                    refreshRect(-1);
                    break;
                case "ArrowRight":
                    refreshRect(1);
                    break;
                case " ":
                    if (lives > 0){
                        shot();
                    } else {
                        lives = maxLives;
                        score = 0;
                        document.getElementById(gameOverId).innerHTML = gameInProgressTxt;
                        targetLoop = setInterval(function newTarget(){
                                                    generateTarget();
                                                } , newTargetDelay);
                        refreshLoop = setInterval(function refresh(){
                                                    refreshScene();
                                                } , sceneRefreshDelay);
                    }
                    break;
            }
        }

        // function is refreshing scene, redraw all elements
        function refreshScene()
        {
            canvas.width = canvas.width;
            if (bulletPositionX != 0){
                updateBubble(bulletPositionX, bulletPositionY, bulletRadius, bulletColor);
            }
            updateTargets(targetsPositionX, targetPositionY, targetRadius, targetColor);
            updateRect(rectPositionX, rectPositionY, rectWidth, rectHeight, rectColor);
            document.getElementById(scoreId).innerHTML = score;
            document.getElementById(livesId).innerHTML = lives;
            if (lives == 0){
                gameOver();
            }
        }

        // refresh rectange image
        function refreshRect(sign){
            const rectStep = 20;
            rectPositionX = rectPositionX + rectStep * sign;
        }

        // create bullets params and define shot loop
        function shot(){
            const bulletDelay = 5;
            const bulletStep = 6;
            if (bulletPositionX == 0){
                bulletPositionX = rectPositionX + rectWidth / 2.0;
                bulletPositionY = rectPositionY - bulletRadius;
                var bulletMove = setInterval(function a(){
                    bulletPositionY -= bulletStep;
                    if (bulletPositionY < 0){
                        clearInterval(bulletMove);
                        bulletPositionX = 0;
                    }
                    else if (bulletPositionY < targetPositionY + targetRadius){
                        for (var i = 0; i < targetsPositionX.length; i++)
                        {
                            if (bulletPositionX + bulletRadius > targetsPositionX[i] - targetRadius &&
                                bulletPositionX - bulletRadius < targetsPositionX[i] + targetRadius)
                            {
                                targetsPositionX.splice(i, 1);
                                ++score;
                                clearInterval(bulletMove);
                                bulletPositionX = 0;
                                break;
                            }
                        }
                    }
                } , bulletDelay);
            }
        }

        // update bubble
        function updateBubble(x, y, r, color){
            ctx.fillStyle = color;
            ctx.beginPath()
            arc = ctx.arc(x, y, r, 0, 2 * Math.PI);
            ctx.fill();
        }

        // update rect
        function updateRect(x, y, w, h, color){
            ctx.fillStyle = rectColor;
            rect = ctx.fillRect(x, y, w, h);
        }

        // generate new target
        function generateTarget(){
            if (targetsPositionX.length < 4){
                var newPositionX = getRandomInt(targetRadius, canvas.width - targetRadius);
                targetsPositionX.push(newPositionX);
            } else {
                --lives;
                targetsPositionX = [];
            }
        }

        // update all targets
        function updateTargets(xTable, y, r, color){
            for (const x of xTable)
            {
                ctx.fillStyle = color;
                ctx.beginPath()
                target = ctx.arc(x, y, r, 0, 2 * Math.PI);
                ctx.fill();
            }
        }

        // gave over flow
        function gameOver(){
            targetsPositionX = [];
            clearInterval(targetLoop);
            clearInterval(refreshLoop);
            document.getElementById(gameOverId).innerHTML = gameOverTxt;
        }

        // define canvas and create context
        var canvas = document.getElementById("bubbleGame");
        var ctx = canvas.getContext("2d");

        // define rectangle params
        const rectColor = rgb(231, 123, 132);
        const rectWidth = canvas.offsetWidth / 8.0;
        const rectHeight = canvas.offsetWidth / 40.0;
        const rectPositionY = canvas.offsetHeight - rectHeight;
        var rectPositionX = canvas.offsetWidth / 2.0 - rectWidth / 2.0;

        // create rectangle
        ctx.fillStyle = rectColor;
        rect = ctx.fillRect(rectPositionX, rectPositionY, rectWidth, rectHeight);
        ctx.stroke();

        // register events
        window.addEventListener('keydown', this.keyCallback, event)

        // set up bullet params
        const bulletColor = rgb(0, 0, 180);
        const bulletRadius = rectHeight / 2.0;
        var bulletPositionX = 0;
        var bulletPositionY = 0;

        // set up target params
        const targetColor = rgb(200, 20, 20);
        const targetRadius = bulletRadius * 3;
        const targetPositionY = targetRadius + 10;
        var targetsPositionX = [];
        var newTargetDelay = 1000;
        var targetLoop = setInterval(function newTarget(){
                                            generateTarget();
                                        }, newTargetDelay);

        // settings scene refresh params
        const sceneRefreshDelay = 10;
        var refreshLoop = setInterval(function refresh(){
                                            refreshScene();
                                        }, sceneRefreshDelay);

        // set score dependencies
        const scoreId = 'score';
        var score = 0;

        // set lives dependencies
        const gameOverId = "gameover";
        const gameOverTxt = "Game Over!!! Press space to try again.";
        const gameInProgressTxt = "Good luck!";
        const livesId = 'lives';
        const maxLives = 3;
        var lives = maxLives;

    </script>
</body>
</html>
