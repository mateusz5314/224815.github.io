<!doctype html>

<html lang="pl">
<head>
<title>Programowanie Gier 2D Mateusz J.</title>
  <meta charset="utf-8">
  <meta name="description" content="Zrealizowanie gry w ramach zadania Animacja2.">
  <meta name="author" content="Mateusz Janiak">
  <style>
      #carGame{
          background-color: green;
          width: 800px;
          height: 600px;
          border: 2px solid #d3d3d3;
      }
  </style>
</head>

<body>
    <a href="index.html">Wroc</a><br/>
    <p>Score: </p></p><p id="score"></p><br />
    <canvas id="carGame"> </canvas><br />
    <script>
        var canvas = document.getElementById('carGame'),
        context = canvas.getContext('2d');
        const scoreId = 'score';
        const road = 'animacja3-img\\road.png';
        const roadL = 'animacja3-img\\roadL.png';
        const roadR = 'animacja3-img\\roadR.png';
        const car = 'animacja3-img\\car.png';
        const carL = 'animacja3-img\\carL.png';
        const carR = 'animacja3-img\\carR.png';

        const carW = 10;
        const carH = 10;
        const carY = canvas.height - canvas.height * 0.35;
        var carModifier = 0;
        var carX = canvas.width / 2.0;
        var carImg = car;

        var roadStep = 2;
        var roadUpdateDelay = 20;
        var roadDirection = "s";
        var roadXposition = 50;
        var roadImgStack = [];
        var roadXStack = [];
        var roadYStack = [];
        var roadWStack = [];
        var roadHStack = [];

        var roadEdgeL = [roadXposition + 40];
        var roadEdgeR = [roadXposition + 155];

        var score = 0;

        addRoadToStack(road, roadXposition, 0, 200, 100);

        function checkOnRoad()
        {
            if (carX > roadEdgeL.at(0) && carX + carW < roadEdgeR.at(0))
            {
                score++;
            }
            else
            {
                roadUpdateDelay = 20;
                roadDirection = "s";
                roadXposition = 50;
                roadImgStack = [];
                roadXStack = [];
                roadYStack = [];
                roadWStack = [];
                roadHStack = [];
                roadEdgeL = [roadXposition + 40];
                roadEdgeR = [roadXposition + 155];
                carModifier = 0;
                carX = canvas.width / 2.0;
                carImg = car;
                score = 0;
                addRoadToStack(road, roadXposition, 0, 200, 100);
            }
        }

        function setImg(src, x, y, w, h)
        {
            var img = new Image();
            img.addEventListener('load', function() {
                context.drawImage(img, x, y, w, h);
            }, false);
            img.src = src;
        }

        function refreshDisplay()
        {
            context.clearRect(0,0,canvas.width, canvas.height);
            for (var i = 0; i < roadImgStack.length; i++)
            {
                setImg(roadImgStack[i], roadXStack[i], roadYStack[i], roadWStack[i], roadHStack[i])
            }

            moveCar();
            checkOnRoad();
            document.getElementById(scoreId).innerHTML = score;
        }

        function addRoadToStack(src, x, y, w, h)
        {
            roadImgStack.push(src);
            roadXStack.push(x);
            roadYStack.push(y);
            roadWStack.push(w);
            roadHStack.push(h);
            var change = 0.0;
            if (src == roadL)
            {
                change = -0.37;
            }
            else if (src == roadR)
            {
                change = 0.37;
            }
            for (var i = 0; i < 247; i+=roadStep)
            {
                roadEdgeL.push(roadEdgeL.at(-1) + change);
                roadEdgeR.push(roadEdgeR.at(-1) + change);
            }
        }

        function removeRoadFromStack(i)
        {
            roadImgStack.splice(i, 1);
            roadXStack.splice(i, 1);
            roadYStack.splice(i, 1);
            roadWStack.splice(i, 1);
            roadHStack.splice(i, 1);
        }

        function updateRoad()
        {
            for (var i = 0; i < roadYStack.length; i++)
            {
                if (roadYStack[i] == 0)
                {
                    var newRoad = road;

                    const nextRoad = getRandomInt(0, 3);
                    if (nextRoad != 0)
                    {
                        if (nextRoad == 1)
                        {
                            if (roadXposition < 10)
                            {
                                newRoad = roadR;
                            }
                            else
                            {
                                newRoad = roadL;
                            }
                        }
                        else
                        {
                            if (roadXposition > 90)
                            {
                                newRoad = roadL;
                            }
                            else
                            {
                                newRoad = roadR;
                            }
                        }
                    }
                    shiftRoadX(newRoad)
                    addRoadToStack(newRoad, roadXposition, -100, 200, 100);
                }
                roadYStack[i] += roadStep;
                roadEdgeL.shift();
                roadEdgeR.shift();
                if (roadYStack[i] == canvas.height)
                {
                    removeRoadFromStack(i);
                    i--;
                }
            }
        }

        function shiftRoadX(newRoad)
        {
            if (roadDirection == 's')
            {
                if (newRoad == roadL)
                {
                    roadDirection = 'l';
                    roadXposition -= 22;
                }
                else if (newRoad == roadR)
                {
                    roadDirection = 'r';
                    roadXposition += 22;
                }
            }
            else if (roadDirection == 'l')
            {
                if (newRoad == roadL)
                {
                    roadXposition -= 44;
                }
                else if (newRoad == road)
                {
                    roadDirection = 's';
                    roadXposition -= 22;
                }
                else if (newRoad == roadR)
                {
                    roadDirection = 'r';
                }
            }
            else if (roadDirection == 'r')
            {
                if (newRoad == roadR)
                {
                    roadDirection = 'r';
                    roadXposition += 44;
                }
                else if (newRoad == road)
                {
                    roadDirection = 's';
                    roadXposition += 22;
                }
                else if (newRoad == roadL)
                {
                    roadDirection = 'l';
                }
            }
        }

        function keyUpCallback(event){
            switch (event.key) {
                case "ArrowLeft":
                case "ArrowRight":
                    carModifier = 0;
                    break;
            }
        }

        function keyDownCallback(event){
            switch (event.key) {
                case "ArrowLeft":
                    carModifier = -1;
                    break;
                case "ArrowRight":
                    carModifier = 1;
                    break;
            }
        }

        function moveCar()
        {
            const carStep = 2;
            carX += carModifier * carStep;
            if (carModifier > 0)
            {
                carImg = carR;
            }
            else if (carModifier < 0)
            {
                carImg = carL;
            }
            else
            {
                carImg = car;
            }
            setImg(carImg, carX, carY, carW, carH);
        }


        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
        }

        window.addEventListener('keydown', this.keyDownCallback, event);
        window.addEventListener('keyup', this.keyUpCallback, event);

        const sceneRefreshDelay = 10;
        setInterval(function refresh()
                    {
                        refreshDisplay();
                    },
                    sceneRefreshDelay);

        setInterval(function refresh()
                    {
                        updateRoad();
                    },
                    roadUpdateDelay);
    </script>
</body>
</html>
